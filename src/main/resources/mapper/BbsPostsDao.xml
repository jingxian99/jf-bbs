<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jfsoft.bbs.dao.BbsPostsDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.jfsoft.bbs.entity.BbsPostsEntity" id="bbsPostsMap">
        <result property="id" column="id"/>
        <result property="content" column="content"/>
        <result property="good" column="good"/>
        <result property="initTime" column="init_time"/>
        <result property="labelId" column="label_id"/>
        <result property="replyCount" column="reply_count"/>
        <result property="title" column="title"/>
        <result property="top" column="top"/>
        <result property="userId" column="user_id"/>
        <result property="end" column="end"/>
        <result property="author" column="author"/>
        <result property="icon" column="icon"/>
        <result property="labelName" column="label_name"/>
        <result property="rewardGrade" column="reward_grade"/>
        <result property="collectionStatus" column="collection_status"/>
        <result property="collectionTime" column="collection_time"/>
        <result property="isDel" column="is_del"/>
    </resultMap>

    <select id="getList" parameterType="map" resultMap="bbsPostsMap">
        SELECT DISTINCT bp.id as id, bp.good as good, bp.user_id as user_id, bp.content as content, bp.init_time as init_time,
        bp.label_id as label_id, bl.name as label_name, bp.reply_count as reply_count, bp.title as title, bp.top as top,
        bp.end as end, bp.reward_grade as reward_grade, bu.username as author, bu.icon as icon
        , (select init_time from bbs_reply where posts_id=bp.id order by init_time desc limit 1) as replytime
        FROM bbs_posts bp
        LEFT JOIN bbs_user bu ON bp.user_id = bu.id
        LEFT JOIN bbs_label bl ON bl.id = bp.label_id
        LEFT JOIN bbs_reply br ON bp.id = br.posts_id
        WHERE 1 = 1
        <if test="good != null and good != ''">
            AND bp.good = true
        </if>
        <if test="end != null">
            AND bp.end = #{end}
        </if>
        <if test="labelId != null and labelId != ''">
            AND bp.label_id = #{labelId}
        </if>
        <if test="beginTime != null and beginTime != ''">
            AND bp.init_time &gt;= #{beginTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND bp.init_time &lt;= #{endTime}
        </if>
        AND bp.is_del = false
        ORDER BY replytime DESC
        <if test="order != null and order != ''">
            ,
            <choose>
                <when test="order == 'init_time'">
                    bp.init_time DESC
                </when>
                <when test="order == 'reply_count'">
                    bp.reply_count DESC
                </when>
            </choose>
        </if>
        LIMIT #{startPage}, #{endPage}
    </select>

    <select id="getTopList" parameterType="map" resultMap="bbsPostsMap">
        SELECT bp.id as id, bp.good as good, bp.user_id as user_id, bp.content as content, bp.init_time as init_time,
        bp.label_id as label_id, bl.name as label_name, bp.reply_count as reply_count, bp.title as title, bp.top as top,
        bp.end as end, bp.reward_grade as reward_grade, bu.username as author, bu.icon as icon
        FROM bbs_posts bp
        LEFT JOIN bbs_user bu ON bp.user_id=bu.id
        LEFT JOIN bbs_label bl ON bl.id = bp.label_id
        WHERE 1 = 1
          AND bp.top = TRUE
          ORDER BY bp.init_time DESC , bp.reply_count DESC
        LIMIT 0, 4
    </select>

    <select id="getPostByID" parameterType="integer" resultMap="bbsPostsMap">
        SELECT bp.id as id, bp.good as good, bp.user_id as user_id, bp.content as content, bp.init_time as init_time,
        bp.label_id as label_id, bp.reply_count as reply_count, bp.title as title, bp.top as top, bp.end as end,
        bp.reward_grade as reward_grade, bu.username as author, bu.icon as icon, IFNULL(bc.status, FALSE) as collection_status
        FROM bbs_posts bp
        LEFT JOIN bbs_user bu ON bp.user_id = bu.id
        LEFT JOIN bbs_collection bc ON bc.post_id = bp.id AND bc.user_id = #{userId}
        WHERE bp.id = #{id}
    </select>

    <select id="getPostByCollection" parameterType="integer" resultMap="bbsPostsMap">
        SELECT bp.*, bc.init_time as collection_time
        FROM bbs_collection bc LEFT JOIN bbs_posts bp ON bc.post_id = bp.id
        WHERE bc.user_id = #{userId} ORDER BY bc.init_time DESC
    </select>


</mapper>